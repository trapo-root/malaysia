<div id="dropdown-container">
  <select id="brand-dropdown">
    <option value="">Select Brand</option>
  </select>

  <select id="model-dropdown" disabled>
    <option value="">Select Model</option>
  </select>

  <select id="year-dropdown" disabled>
    <option value="">Select Year</option>
  </select>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded and parsed'); // Debugging

    const brands = new Set();
    const models = new Set();
    const years = new Set();
    const limit = 250;

    function fetchProducts(page, brand = null, model = null) {
      let url = `/collections/trapo-classic-car-mats/products.json?limit=${limit}&page=${page}`;
      if (brand) {
        url += `&tag=brand:${brand}`;
      }
      if (model) {
        url += `&tag=model:${model}`;
      }
      console.log(`Fetching products from URL: ${url}`); // Debugging
      return fetch(url)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok ' + response.statusText);
          }
          return response.json();
        })
        .then(data => {
          console.log(`Fetched ${data.products.length} products from page ${page}`); // Debugging
          data.products.forEach(product => {
            product.tags.forEach(tag => {
              if (tag.startsWith('brand:')) {
                brands.add(tag.replace('brand:', '').trim());
              } else if (tag.startsWith('model:')) {
                models.add(tag.replace('model:', '').trim());
              } else if (tag.startsWith('year:')) {
                years.add(tag.replace('year:', '').trim());
              }
            });
          });
          return data.products.length;
        })
        .catch(error => {
          console.error('There has been a problem with your fetch operation:', error); // Debugging
        });
    }

    function populateDropdown(dropdown, items) {
      dropdown.innerHTML = '<option value="">Select</option>';
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        dropdown.appendChild(option);
      });
      dropdown.disabled = false;
    }

    function fetchAllBrands(page = 1) {
      brands.clear();
      function fetchPage(page) {
        fetchProducts(page).then(count => {
          if (count === limit) {
            fetchPage(page + 1);
          } else {
            populateDropdown(document.getElementById('brand-dropdown'), brands);
          }
        });
      }
      fetchPage(page);
    }

    function fetchModelsForBrand(brand, page = 1) {
      models.clear();
      function fetchPage(page) {
        fetchProducts(page, brand).then(count => {
          if (count === limit) {
            fetchPage(page + 1);
          } else {
            populateDropdown(document.getElementById('model-dropdown'), models);
          }
        });
      }
      fetchPage(page);
    }

    function fetchYearsForModel(brand, model, page = 1) {
      years.clear();
      function fetchPage(page) {
        fetchProducts(page, brand, model).then(count => {
          if (count === limit) {
            fetchPage(page + 1);
          } else {
            populateDropdown(document.getElementById('year-dropdown'), years);
          }
        });
      }
      fetchPage(page);
    }

    document.getElementById('brand-dropdown').addEventListener('change', function() {
      const brand = this.value;
      if (brand) {
        fetchModelsForBrand(brand);
      } else {
        document.getElementById('model-dropdown').innerHTML = '<option value="">Select Model</option>';
        document.getElementById('model-dropdown').disabled = true;
        document.getElementById('year-dropdown').innerHTML = '<option value="">Select Year</option>';
        document.getElementById('year-dropdown').disabled = true;
      }
    });

    document.getElementById('model-dropdown').addEventListener('change', function() {
      const brand = document.getElementById('brand-dropdown').value;
      const model = this.value;
      if (model) {
        fetchYearsForModel(brand, model);
      } else {
        document.getElementById('year-dropdown').innerHTML = '<option value="">Select Year</option>';
        document.getElementById('year-dropdown').disabled = true;
      }
    });

    // Fetch all brands on page load
    fetchAllBrands();
  });
</script>