<style>
    /*   hide quantity seelctor of promotional and addon type products */
      #wow-cart-drawer-app .wow-cart-product-item[data-product_type="Add-On"] .wow-cart-quantity-box,
    #wow-cart-drawer-app .wow-cart-product-item[data-product_type="Promotional"] .wow-cart-quantity-box {
      display: none;
    }
      form#wowcart-cart-form{
        margin-bottom:0
      }
    #wow-cart-drawer-app .wow-cart-box-wrapper {
          height: 100% !important;
    }

    #wow-cart-drawer-app .wowcart_custom-placeholder {

      padding-left: 8px !important;
      padding-right: 8px !important;
  }

     .wow-cart-quantity__value {
    margin: unset !important;
  }

  .wow-cart-fixed-form {
  margin-bottom: unset !important;
  }

  .wow-cart-hide-item + .wowcart_custom-placeholder {
    display: none !important;
  }

     #wow-cart-drawer-app .wowcart-product-item__footer-content {

      max-width: fit-content !important;
      flex-wrap: wrap !important;
  }
     /* .wowcart-product-item__footer{
       display:none !important;
     } */
     /* .wow-cart-product-item{
       margin-bottom:10px !important;
     } */
</style>

<script
  id="wowcart-custom-script"
>

 function removeQuantitySelector(){
      const product_types =['Add-On','Promotional'];
      
          (product_types || []).forEach(type => {
          Array.from(document.querySelectorAll(`#wow-cart-drawer-app .wow-cart-product-item[data-product_type="${type}"] .wow-cart-quantity-box`) || []).forEach(ele => {
            ele.remove();
          });
        });
  }
  function removeUfeWidgetsAndRefresh() {
  // 1. Select all elements with the class 'ufe-widget'
  const ufeWidgets = document.querySelectorAll('.ufe-widget:not(.ufe-popup .ufe-widget)');

  // 2. Remove each widget from the DOM
  ufeWidgets.forEach(widget => {
    widget.remove(); 
  });

  // 3. Call the refresh function 
  if (typeof window.ufe !== 'undefined' && typeof window.ufe.refreshUpsell() === 'function') {
    window.ufe.refreshUpsell();
  } else {
    console.warn('ufe is not defined');
  }
}

  // Initialize store pickup div if not present
  function initStorePickupDiv() {
    const holder = document.querySelector('#genie-store-pickup-front-holder-drawer');
    if (!holder) {
      const div = document.createElement('div');
      div.id = 'genie-store-pickup-front-holder-drawer';
      div.dataset.storeDomain = "{{ shop.permanent_domain }}";
      console.log("div : ", div)
      const targetElement = document.querySelector('.wowcart_custom-placeholder');
      if (targetElement) {
        targetElement.appendChild(div);
        setTimeout(loadStorePickup, 0); // Assuming loadStorePickup is defined elsewhere
        console.log("initStorePickupDiv created for calling : ", targetElement)
      }
    }
  }

  // Initialize store pickup div if not present
  function initOrGetLocsStorePickup() {
    // Reinitialize the store pickup div
    if (typeof initStorePickupDiv === 'function') {
        console.log('Reinitializing Store Pickup Div');
         // var getclasscheckoutMethodName= document.getElementsByClassName("checkoutMethodName")
    // if (!getclasscheckoutMethodName || getclasscheckoutMethodName.length == 0) { 
        if ($('.genie-app .checkoutMethodName').length == 0) {
          console.log("in init genie");
          initStorePickupDiv();  
        } else if ($('.genie-app .checkoutMethodName').length > 0 && $('.genie-app .checkoutMethod.active').text() == 'Store Pickup') {
          console.log("in get loc genie");
          getGenieLocations();
        }
    } else {
        console.warn('initStorePickupDiv is not defined');
    }
  }

  //Cart Loaded event
   document.addEventListener('WOWCART_LOADED', () => {
     console.log("This is inside THE WOW CART OPEN ------------>")

     var imgUrl = "https://cdn.shopify.com/s/files/1/0234/7089/9277/files/Store-Pickup-Banner_99de990c-03b2-4921-8430-1b279ea48817.png?v=1759118211";
var $container = $('.wowcart_custom-placeholder');

// Check if the image is already present
if ($container.find('img[src="' + imgUrl + '"]').length === 0) {
  $container.prepend('<img src="' + imgUrl + '" style="width: 100%;padding-top: 10px;">');
}
     setTimeout(function () {
                if ($(".dashcam-note").length == 0) {
              $('[data-product_type="TRAPO DASHCAM"] .wow-cart-product-price-block').append('<p class="dashcam-note" style="color: red;font-size: 11px;font-weight: 700;letter-spacing: 0.4px;padding-top: 2px;">NOTE : Choose Store Pickup for free installation</p>');
                }
                }, 550);
        console.log('WOW cart loaded')
     removeUfeWidgetsAndRefresh();
        removeQuantitySelector();
        initStorePickupDiv();
      {% if customer %}
      // if(!document.querySelector('#loyalty-point')){
      //   // header
      //   const div_top = document.createElement('div');
      //     // Set Attributes on Element
      //     div_top.setAttribute('id', 'loyalty-point-top');
      //     const SELECTOR_TOP = '.slider-cart-top-bar.sider-cart-header';
      //     const element_top = document.querySelector(SELECTOR_TOP);
      //     element_top.after(div_top);
      //     const loyaltyPointElement_top = document.querySelector('#loyalty-point-top');
      //     loyaltyPointElement_top.innerHTML = `<span class="points-on-cart">You have <span data-lion-points="approved"></span> points</span><span class="plus-points-cart">(Plus, earn
      //     <span data-lion-points="cart"></span> points with this order.)`;

       
      //  // footer
          // const div = document.createElement('div');
          // // Set Attributes on Element
          // div.setAttribute('id', 'loyalty-point');
          // const SELECTOR = '.slider-cart-footer-note';
          // const element = document.querySelector(SELECTOR);
          // element.before(div);
          // const loyaltyPointElement = document.querySelector('#loyalty-point');
          // loyaltyPointElement.innerHTML = `<span class="points-on-cart">You have <span data-lion-points="approved"></span> points</span><span class="plus-points-cart">(Plus, earn
          // <span data-lion-points="cart"></span> points with this order.)`;       
        //}
        {% endif %}     
  });

  
document.addEventListener('WOWCART_PRODUCT_DELETED', function(items) { 
const cartObject = items.detail || {};
   if(cartObject.item_count > 0){
      let addonProducts = ((wowcart.cartItems || {}).items || []).filter(item=>item.product_type == 'Add-On' || item.product_type == 'Promotional' || item.product_type == 'Reward')
        if((addonProducts||{}).length == (wowcart.cartItems || {}).item_count){
          (window.wowcart || {}).clearCart && (window.wowcart || {}).clearCart();
        }  
    }
  initOrGetLocsStorePickup();
});



(function() {
  // Listen for CART_UPDATED event
  document.addEventListener('CART_UPDATED', function(event) {
    const cartObject = event.detail || {};
    console.log('Hii', cartObject);

    // --- EXISTING LOGIC STARTS ---
    if (document.querySelector('.pickup-in-store-1')) {
      if (!$('.pickup-in-store-1').hasClass("addedNote")) {
        $(".pickup-in-store-1 .wow-cart-product-price-block").append("<p class='pickup-note'>Note : Our staff will contact you once your item is available to pick up</p>");
      }
      $('.pickup-in-store-1').addClass('addedNote');
    }

    //clear cart if cart only has free products
    if (cartObject.item_count > 0 && cartObject.items_subtotal_price === 0) {
      let addonProducts = ((window.wowcart || {}).cartItems || {}).items || [];
      // Fallback if window.wowcart isn't populated as expected, try using cartObject if possible
      // But sticking to provided logic strictness:
      if (!addonProducts.length && cartObject.items) {
          addonProducts = cartObject.items;
      }
      
      addonProducts = addonProducts.filter(item => item.product_type == 'Add-On' || item.product_type == 'Promotional' || item.product_type == 'Reward');
      
      // Careful with the original logic referring to 'wowcart', keeping it safe
      const currentCount = (window.wowcart || {}).item_count || cartObject.item_count;
      
      if ((addonProducts || {}).length == currentCount) {
        (window.wowcart || {}).clearCart && (window.wowcart || {}).clearCart();
      }
    }
    removeQuantitySelector();
    initOrGetLocsStorePickup();
    // --- EXISTING LOGIC ENDS ---

    // ---------------------------------------------------------
    // NEW FREE GIFT LOGIC START
    // ---------------------------------------------------------
    
    try {
        const items = cartObject.items || [];
        
        // Gift Variant IDs
        const GIFT_IDS = {
            GIFT_1: 42418196643917,
            GIFT_2: 42612581498957,
            GIFT_3: 41705709830221
        };

        // Initialize required quantities
        let requiredQty = {
            [GIFT_IDS.GIFT_1]: 0,
            [GIFT_IDS.GIFT_2]: 0,
            [GIFT_IDS.GIFT_3]: 0
        };

        // Scan items to calculate required gifts
        items.forEach(item => {
            const productType = (item.product_type || '').toUpperCase();
            const variantOptions = item.variant_options || [];
            const thirdOption = variantOptions[2] || ''; // Index 2 is the 3rd option
            const quantity = item.quantity || 0;

            // Condition A: WIPER
            if (productType === 'WIPER') {
                requiredQty[GIFT_IDS.GIFT_1] += quantity;
            }

            // Condition B: TRAPO CLASSIC + Front + Rear
            else if (productType === 'TRAPO CLASSIC' && thirdOption === 'Front + Rear') {
                requiredQty[GIFT_IDS.GIFT_1] += quantity;
            }

            // Condition C: TRAPO CLASSIC + All Included
            else if (productType === 'TRAPO CLASSIC' && thirdOption === 'All Included') {
                requiredQty[GIFT_IDS.GIFT_1] += quantity;
                requiredQty[GIFT_IDS.GIFT_2] += quantity;
            }

            // Condition D: TRAPO HEX + All Included
            else if (productType === 'TRAPO HEX' && thirdOption === 'All Included') {
                requiredQty[GIFT_IDS.GIFT_1] += quantity;
                requiredQty[GIFT_IDS.GIFT_2] += quantity;
                requiredQty[GIFT_IDS.GIFT_3] += quantity;
            }
        });

        // Current quantities in cart
        let currentQty = {
            [GIFT_IDS.GIFT_1]: 0,
            [GIFT_IDS.GIFT_2]: 0,
            [GIFT_IDS.GIFT_3]: 0
        };

        items.forEach(item => {
            if (requiredQty.hasOwnProperty(item.variant_id)) {
                currentQty[item.variant_id] = item.quantity;
            }
        });

        // Determine if updates are needed
        let updates = {};
        let needsUpdate = false;

        for (const [id, qty] of Object.entries(requiredQty)) {
            if (currentQty[id] !== qty) {
                updates[id] = qty;
                needsUpdate = true;
            }
        }

        // Perform update if needed
        if (needsUpdate) {
            console.log('Free Gift Logic: Updating cart', updates);
            
            fetch('/cart/update.js', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ updates: updates })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Cart updated successfully', data);
                // Note: The /cart/update.js call might trigger CART_UPDATED again depending on the theme implementation.
                // Our logic is idempotent (checks state first), so infinite loops are prevented.
            })
            .catch(error => {
                console.error('Error updating cart for free gifts:', error);
            });
        }

    } catch (e) {
        console.error('Error in Free Gift Logic:', e);
    }

  });
})();
</script>
